<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoTracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; margin-top: 20px; }
        .table { background-color: white; }
        .navbar-brand { font-weight: bold; }
        .alert-dismissible { position: relative; }
        .chart-container { width: 100%; height: 400px; }
    </style>
</head>
<body>
    <div class="container">
        {% if section == 'login' %}
            <h2>Login</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}
            <form method="POST" action="{{ url_for('login') }}">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p class="mt-3">Don't have an account? <a href="{{ url_for('register') }}">Register</a></p>
        {% elif section == 'register' %}
            <h2>Register</h2>
            {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}
            <form method="POST" action="{{ url_for('register') }}">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Register</button>
            </form>
            <p class="mt-3">Already have an account? <a href="{{ url_for('login') }}">Login</a></p>
        {% elif section == 'verify' %}
            <h2>Verify Your Account</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %} 
            {% endwith %}
            {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}
            <p>A verification code has been sent to your email. Please enter it below.</p>
            <form method="POST" action="{{ url_for('verify', email=email) }}">
                <div class="mb-3">
                    <label for="code" class="form-label">Verification Code</label>
                    <input type="text" class="form-control" id="code" name="code" required>
                </div>
                <button type="submit" class="btn btn-primary">Verify</button>
            </form>
            <p class="mt-3"><a href="{{ url_for('login') }}">Back to Login</a></p>
        {% elif section == 'dashboard' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="#">CryptoTracker</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Price Alert Notifications</h3>
                <form method="POST" action="{{ url_for('refresh_alerts') }}">
                    <button type="submit" class="btn btn-secondary">Refresh Alerts</button>
                </form>
            </div>
            <div id="notificationsContainer">
                {% if triggered_alerts %}
                    {% for alert in triggered_alerts %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>Alert!</strong> {{ alert.coin_id | capitalize }} price is {{ alert.alert_type }} ${{ alert.target_price | round(2) }} (Triggered at {{ alert.triggered_at }}).
                            <a href="{{ url_for('live_market') }}" class="btn btn-sm btn-primary">Trade Now</a>
                            <form method="POST" action="{{ url_for('dismiss_alert', notification_id=alert.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-secondary">Dismiss</button>
                            </form>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No new alerts at this time.</p>
                {% endif %}
            </div>
            {% if user %}
                <p><strong>CryptoBucks Balance:</strong> ${{ user.crypto_bucks | round(2) }}</p>
                <p><strong>Risk Tolerance:</strong> {{ user.risk_tolerance }}</p>
            {% endif %}
            <h3>Market Overview (Top Market Caps)</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Price (USD)</th>
                        <th>24h Change</th>
                        <th>Market Cap</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if coins %}
                        {% for coin in coins %}
                            <tr>
                                <td>{{ coin.name }}</td>
                                <td>${{ coin.current_price | round(2) }}</td>
                                <td>{{ coin.price_change_percentage_24h | round(2) }}%</td>
                                <td>${{ coin.market_cap | round(2) }}</td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-info" onclick="showChart('{{ coin.id }}')">View Chart</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <script>
                let chartInstance = null;
                function showChart(coinId) {
                    fetch(`/historical/${coinId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            const ctx = document.getElementById('priceChart').getContext('2d');
                            if (chartInstance) {
                                chartInstance.destroy();
                            }
                            chartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.dates,
                                    datasets: [
                                        {
                                            label: `${coinId.toUpperCase()} Price (USD)`,
                                            data: data.prices,
                                            borderColor: 'blue',
                                            yAxisID: 'y-price',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Volume (USD)`,
                                            data: data.volumes,
                                            borderColor: 'green',
                                            yAxisID: 'y-volume',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Market Cap (USD)`,
                                            data: data.market_caps,
                                            borderColor: 'red',
                                            yAxisID: 'y-market-cap',
                                            fill: false
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            display: true,
                                            title: { display: true, text: 'Date' }
                                        },
                                        'y-price': {
                                            type: 'linear',
                                            position: 'left',
                                            display: true,
                                            title: { display: true, text: 'Price (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-volume': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Volume (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-market-cap': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Market Cap (USD)' },
                                            grid: { drawOnChartArea: false }
                                        }
                                    }
                                }
                            });
                        });
                }
            </script>
        {% elif section == 'live_market' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            <h2>Live Cryptocurrency Market</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Symbol</th>
                        <th>Price (USD)</th>
                        <th>24h Change</th>
                        <th>Market Cap</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if coins %}
                        {% for coin in coins %}
                            <tr>
                                <td>{{ coin.name }}</td>
                                <td>{{ coin.symbol }}</td>
                                <td>${{ coin.current_price | round(2) }}</td>
                                <td>{{ coin.price_change_percentage_24h | round(2) }}%</td>
                                <td>${{ coin.market_cap | round(2) }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('trade') }}">
                                        <input type="hidden" name="coin_id" value="{{ coin.id }}">
                                        <input type="hidden" name="current_price" value="{{ coin.current_price }}">
                                        <input type="hidden" name="source" value="live_market">
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="number" class="form-control" name="amount" placeholder="Amount" step="0.00000001" required>
                                            <select name="wallet_id" class="form-select" required>
                                                <option value="" disabled selected>Select Wallet</option>
                                                {% if wallets %}
                                                    {% for wallet in wallets %}
                                                        <option value="{{ wallet.id }}">{{ wallet.name }}</option>
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                            <button type="submit" name="action" value="buy" class="btn btn-sm btn-success">Buy</button>
                                        </div>
                                    </form>
                                    <a href="#" class="btn btn-sm btn-info" onclick="showChart('{{ coin.id }}')">View Chart</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
            {% if section == 'live_market' %}
                <nav>
                    <ul class="pagination">
                        {% if page > 1 %}
                            <li class="page-item"><a class="page-link" href="{{ url_for('live_market', page=page-1) }}">Previous</a></li>
                        {% endif %}
                        {% for p in range(1, total_pages + 1) %}
                            <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('live_market', page=p) }}">{{ p }}</a></li>
                        {% endfor %}
                        {% if page < total_pages %}
                            <li class="page-item"><a class="page-link" href="{{ url_for('live_market', page=page+1) }}">Next</a></li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <script>
                let chartInstance = null;
                function showChart(coinId) {
                    fetch(`/historical/${coinId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            const ctx = document.getElementById('priceChart').getContext('2d');
                            if (chartInstance) {
                                chartInstance.destroy();
                            }
                            chartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.dates,
                                    datasets: [
                                        {
                                            label: `${coinId.toUpperCase()} Price (USD)`,
                                            data: data.prices,
                                            borderColor: 'blue',
                                            yAxisID: 'y-price',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Volume (USD)`,
                                            data: data.volumes,
                                            borderColor: 'green',
                                            yAxisID: 'y-volume',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Market Cap (USD)`,
                                            data: data.market_caps,
                                            borderColor: 'red',
                                            yAxisID: 'y-market-cap',
                                            fill: false
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            display: true,
                                            title: { display: true, text: 'Date' }
                                        },
                                        'y-price': {
                                            type: 'linear',
                                            position: 'left',
                                            display: true,
                                            title: { display: true, text: 'Price (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-volume': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Volume (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-market-cap': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Market Cap (USD)' },
                                            grid: { drawOnChartArea: false }
                                        }
                                    }
                                }
                            });
                        });
                }
            </script>
        {% elif section == 'portfolio' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            <h2>Your Portfolio</h2>
            <h3>Add to Portfolio</h3>
            <form method="POST" action="{{ url_for('portfolio') }}">
                <div class="input-group mb-3">
                    <select name="wallet_id" class="form-select" required>
                        <option value="" disabled selected>Select Wallet</option>
                        {% if wallets %}
                            {% for wallet in wallets %}
                                <option value="{{ wallet.id }}">{{ wallet.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <input type="text" class="form-control" name="coin_id" placeholder="Coin ID (e.g., bitcoin)" required>
                    <input type="number" class="form-control" name="amount" placeholder="Amount" step="0.00000001" required>
                    <input type="number" class="form-control" name="purchase_price" placeholder="Purchase Price (USD)" step="0.01" required>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
            <h3>Your Holdings</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Wallet</th>
                        <th>Coin</th>
                        <th>Amount</th>
                        <th>Purchase Price</th>
                        <th>Current Price</th>
                        <th>Profit/Loss</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if transactions %}
                        {% for transaction in transactions %}
                            <tr>
                                <td>Wallet {{ transaction.wallet_id }}</td>
                                <td>{{ transaction.coin_id }}</td>
                                <td>{{ transaction.amount | round(8) }}</td>
                                <td>${{ transaction.price | round(2) }}</td>
                                <td>${{ current_prices.get(transaction.coin_id, 0) | round(2) }}</td>
                                <td>${{ ((current_prices.get(transaction.coin_id, 0) - transaction.price) * transaction.amount) | round(2) }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('trade') }}">
                                        <input type="hidden" name="coin_id" value="{{ transaction.coin_id }}">
                                        <input type="hidden" name="current_price" value="{{ current_prices.get(transaction.coin_id, 0) }}">
                                        <input type="hidden" name="wallet_id" value="{{ transaction.wallet_id }}">
                                        <input type="hidden" name="source" value="portfolio">
                                        <input type="hidden" name="buy_transaction_id" value="{{ transaction.buy_transaction_id }}">
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="number" class="form-control" name="amount" placeholder="Amount" step="0.00000001" required>
                                            <button type="submit" name="action" value="sell" class="btn btn-sm btn-danger">Sell</button>
                                        </div>
                                    </form>
                                    <a href="#" class="btn btn-sm btn-info" onclick="showChart('{{ transaction.coin_id }}')">View Chart</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7">No holdings in your portfolio.</td></tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <script>
                let chartInstance = null;
                function showChart(coinId) {
                    fetch(`/historical/${coinId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            const ctx = document.getElementById('priceChart').getContext('2d');
                            if (chartInstance) {
                                chartInstance.destroy();
                            }
                            chartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.dates,
                                    datasets: [
                                        {
                                            label: `${coinId.toUpperCase()} Price (USD)`,
                                            data: data.prices,
                                            borderColor: 'blue',
                                            yAxisID: 'y-price',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Volume (USD)`,
                                            data: data.volumes,
                                            borderColor: 'green',
                                            yAxisID: 'y-volume',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Market Cap (USD)`,
                                            data: data.market_caps,
                                            borderColor: 'red',
                                            yAxisID: 'y-market-cap',
                                            fill: false
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            display: true,
                                            title: { display: true, text: 'Date' }
                                        },
                                        'y-price': {
                                            type: 'linear',
                                            position: 'left',
                                            display: true,
                                            title: { display: true, text: 'Price (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-volume': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Volume (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-market-cap': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Market Cap (USD)' },
                                            grid: { drawOnChartArea: false }
                                        }
                                    }
                                }
                            });
                        });
                }
            </script>
            <h3>Risk Metrics</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Sharpe Ratio</th>
                        <th>Volatility (Annualized)</th>
                        <th>Max Drawdown</th>
                    </tr>
                </thead>
                <tbody>
                    {% if risk_metrics %}
                        {% for coin_id, metrics in risk_metrics.items() %}
                            <tr>
                                <td>{{ coin_id }}</td>
                                <td>{{ metrics.sharpe_ratio }}</td>
                                <td>{{ metrics.volatility }}</td>
                                <td>{{ metrics.max_drawdown }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="4">No risk metrics available.</td></tr>
                    {% endif %}
                </tbody>
            </table>
            <h3>Asset Correlation Matrix</h3>
            <div class="chart-container">
                <canvas id="correlationChart"></canvas>
            </div>
            <script>
                fetch('/correlation_matrix')
                    .then(response => response.json())
                    .then(data => {
                        if (data.matrix && data.matrix.length > 0) {
                            const ctx = document.getElementById('correlationChart').getContext('2d');
                            new Chart(ctx, {
                                type: 'matrix',
                                data: {
                                    datasets: [{
                                        label: 'Correlation Matrix',
                                        data: data.matrix.flatMap((row, i) => 
                                            row.map((value, j) => ({
                                                x: j,
                                                y: i,
                                                v: Math.round(value * 100) / 100
                                            }))
                                        ),
                                        backgroundColor: (ctx) => {
                                            const value = ctx.dataset.data[ctx.dataIndex].v;
                                            const r = Math.abs(value) * 255;
                                            return value >= 0 ? `rgb(${r}, 0, 0)` : `rgb(0, 0, ${r})`;
                                        },
                                        borderColor: 'black',
                                        borderWidth: 1,
                                        width: ({ chart }) => (chart.chartArea.width / data.labels.length) - 1,
                                        height: ({ chart }) => (chart.chartArea.height / data.labels.length) - 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => {
                                                    const xLabel = data.labels[ctx.raw.x];
                                                    const yLabel = data.labels[ctx.raw.y];
                                                    const value = ctx.raw.v;
                                                    return `${xLabel} vs ${yLabel}: ${value}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            ticks: {
                                                callback: (value) => data.labels[value] || '',
                                                maxRotation: 45,
                                                minRotation: 45
                                            },
                                            grid: { display: false }
                                        },
                                        y: {
                                            ticks: { callback: (value) => data.labels[value] || '' },
                                            grid: { display: false }
                                        }
                                    }
                                }
                            });
                        }
                    });
            </script>
            <h3>Archived Transactions (Sold Coins)</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Wallet</th>
                        <th>Coin</th>
                        <th>Amount</th>
                        <th>Purchase Price</th>
                        <th>Sold Price</th>
                        <th>Profit/Loss</th>
                    </tr>
                </thead>
                <tbody>
                    {% if sold_transactions %}
                        {% for transaction in sold_transactions %}
                            <tr>
                                <td>Wallet {{ transaction.wallet_id }}</td>
                                <td>{{ transaction.coin_id }}</td>
                                <td>{{ transaction.amount | round(8) }}</td>
                                <td>${{ transaction.price | round(2) }}</td>
                                <td>${{ transaction.sold_price | round(2) }}</td>
                                <td>${{ transaction.profit }}</td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
            {% if total_profit is defined and sold_transactions %}
                <p><strong>Total Profit/Loss from Sold Coins:</strong> ${{ total_profit }}</p>
            {% endif %}
        {% elif section == 'watchlist' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            <h2>üîç Your Watchlist</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <h3>Add a Coin to Watch</h3>
            <form method="POST" action="{{ url_for('watchlist') }}">
                <div class="input-group mb-3">
                    {% if available_coins and available_coins|length > 0 %}
                        <select name="coin_id" class="form-select" required>
                            <option value="" disabled selected>Select a coin</option>
                            {% for coin in available_coins %}
                                <option value="{{ coin.id }}">{{ coin.name }} ({{ coin.symbol.upper() }})</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" class="form-control" name="coin_id" placeholder="Enter Coin ID (e.g., bitcoin)" required>
                        <div class="alert alert-warning mt-2" role="alert">
                            No coins available in the dropdown. Please enter a Coin ID manually.
                        </div>
                    {% endif %}
                    <input type="hidden" name="action" value="add">
                    <button type="submit" class="btn btn-primary">Add to Watchlist ‚úÖ</button>
                </div>
            </form>
            <h3>Watched Coins</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Symbol</th>
                        <th>Current Price (USD)</th>
                        <th>24h Change</th>
                        <th>Market Cap</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if coins %}
                        {% for coin in coins %}
                            <tr>
                                <td>{{ coin.name }}</td>
                                <td>{{ coin.symbol }}</td>
                                <td>${{ coin.current_price | round(2) if coin.current_price != 'N/A' else 'N/A' }}</td>
                                <td>{{ coin.price_change_percentage_24h | round(2) if coin.price_change_percentage_24h != 'N/A' else 'N/A' }}%</td>
                                <td>${{ coin.market_cap if coin.market_cap != 'N/A' else 'N/A' }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('watchlist') }}">
                                        <input type="hidden" name="coin_id" value="{{ coin.id }}">
                                        <input type="hidden" name="action" value="remove">
                                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                                    </form>
                                    <a href="#" class="btn btn-sm btn-info" onclick="showChart('{{ coin.id }}')">View Chart</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6">No coins in your watchlist.</td></tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <script>
                let chartInstance = null;
                function showChart(coinId) {
                    fetch(`/historical/${coinId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            const ctx = document.getElementById('priceChart').getContext('2d');
                            if (chartInstance) {
                                chartInstance.destroy();
                            }
                            chartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.dates,
                                    datasets: [
                                        {
                                            label: `${coinId.toUpperCase()} Price (USD)`,
                                            data: data.prices,
                                            borderColor: 'blue',
                                            yAxisID: 'y-price',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Volume (USD)`,
                                            data: data.volumes,
                                            borderColor: 'green',
                                            yAxisID: 'y-volume',
                                            fill: false
                                        },
                                        {
                                            label: `${coinId.toUpperCase()} Market Cap (USD)`,
                                            data: data.market_caps,
                                            borderColor: 'red',
                                            yAxisID: 'y-market-cap',
                                            fill: false
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            display: true,
                                            title: { display: true, text: 'Date' }
                                        },
                                        'y-price': {
                                            type: 'linear',
                                            position: 'left',
                                            display: true,
                                            title: { display: true, text: 'Price (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-volume': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Volume (USD)' },
                                            grid: { drawOnChartArea: false }
                                        },
                                        'y-market-cap': {
                                            type: 'linear',
                                            position: 'right',
                                            display: true,
                                            title: { display: true, text: 'Market Cap (USD)' },
                                            grid: { drawOnChartArea: false }
                                        }
                                    }
                                }
                            });
                        });
                }
            </script>
        {% elif section == 'alerts' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            <h2>Price Alerts</h2>
            <h3>Set New Alert</h3>
            <form method="POST" action="{{ url_for('alerts') }}">
                <div class="input-group mb-3">
                    {% if available_coins and available_coins|length > 0 %}
                        <select name="coin_id" class="form-select" required>
                            <option value="" disabled selected>Select a coin</option>
                            {% for coin in available_coins %}
                                <option value="{{ coin.id }}">{{ coin.name }} ({{ coin.symbol.upper() }})</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" class="form-control" name="coin_id" placeholder="Enter Coin ID (e.g., bitcoin)" required>
                    {% endif %}
                    <input type="number" class="form-control" name="target_price" placeholder="Target Price (USD)" step="0.01" required>
                    <select name="alert_type" class="form-select" required>
                        <option value="above">Above</option>
                        <option value="below">Below</option>
                    </select>
                    <select name="order_type" class="form-select" required>
                        <option value="limit">Limit</option>
                        <option value="market">Market</option>
                        <option value="stop">Stop</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Set Alert</button>
                </div>
            </form>
            <h3>Your Alerts</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Target Price</th>
                        <th>Type</th>
                        <th>Order Type</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if alerts %}
                        {% for alert in alerts %}
                            <tr>
                                <td>{{ alert.coin_id }}</td>
                                <td>${{ alert.target_price | round(2) }}</td>
                                <td>{{ alert.alert_type }}</td>
                                <td>{{ alert.order_type }}</td>
                                <td>{{ alert.status }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('remove_alert', alert_id=alert.id) }}">
                                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        {% elif section == 'risk_quiz' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link active" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Investment Risk Tolerance Assessment</h2>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <div class="alert alert-info">
                            <h5>About This Assessment</h5>
                            <p>This quiz will help determine your investment risk tolerance by evaluating your financial situation, investment goals, and comfort with market fluctuations. Your answers will help us recommend an investment strategy that matches your risk profile.</p>
                        </div>
                        
                        <form method="POST" action="{{ url_for('risk_quiz') }}" class="mt-4">
                            {% for question in questions %}
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            {{ loop.index }}. {{ question.text }}
                                            <small class="text-muted ms-2" data-bs-toggle="tooltip" title="{{ question.explanation }}">
                                                <i class="bi bi-info-circle">‚ÑπÔ∏è</i>
                                            </small>
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        {% for option in question.options %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="{{ question.id }}" id="{{ question.id }}_{{ loop.index }}" value="{{ option.value }}" required>
                                                <label class="form-check-label d-flex align-items-center" for="{{ question.id }}_{{ loop.index }}">
                                                    {{ option.text }}
                                                    <small class="text-muted ms-2" data-bs-toggle="tooltip" title="{{ option.explanation }}">
                                                        <i class="bi bi-info-circle">‚ÑπÔ∏è</i>
                                                    </small>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
                                <button type="submit" class="btn btn-primary">Submit Assessment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <style>
                .form-check-input:checked + .form-check-label {
                    font-weight: 500;
                    color: #0d6efd;
                }
                .card {
                    border: none;
                    border-radius: 10px;
                }
                .card-header {
                    border-radius: 10px 10px 0 0 !important;
                }
                .btn-primary {
                    padding: 0.5rem 2rem;
                    border-radius: 5px;
                }
                [data-bs-toggle="tooltip"] {
                    cursor: help;
                    text-decoration: none;
                }
            </style>
            
            <script>
                // Initialize tooltips
                document.addEventListener('DOMContentLoaded', function() {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                });
            </script>
            </form>
            
        {% elif section == 'risk_quiz_result' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link active" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('achievements') }}">Achievements</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Your Risk Profile Assessment</h2>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-5">
                            <h3 class="mb-3">Your Risk Tolerance: <strong>{{ risk_level }}</strong></h3>
                            
                            <!-- Risk Meter -->
                            <div class="progress mb-4" style="height: 30px; border-radius: 15px; background-color: #e9ecef;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ risk_percent }}%" 
                                     aria-valuenow="{{ risk_percent }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ risk_percent }}%
                                </div>
                            </div>
                            
                            <div class="row
                                {% if risk_percent <= 20 %}
                                    text-danger
                                {% elif risk_percent <= 40 %}
                                    text-warning
                                {% elif risk_percent <= 60 %}
                                    text-primary
                                {% elif risk_percent <= 80 %}
                                    text-info
                                {% else %}
                                    text-success
                                {% endif %}
                                mb-4">
                                <div class="col">
                                    <i class="bi bi-shield-lock" style="font-size: 3rem;"></i>
                                    <div>Conservative</div>
                                </div>
                                <div class="col">
                                    <i class="bi bi-shield" style="font-size: 3rem;"></i>
                                    <div>Moderate</div>
                                </div>
                                <div class="col">
                                    <i class="bi bi-shield-check" style="font-size: 3rem;"></i>
                                    <div>Balanced</div>
                                </div>
                                <div class="col">
                                    <i class="bi bi-shield-plus" style="font-size: 3rem;"></i>
                                    <div>Growth</div>
                                </div>
                                <div class="col">
                                    <i class="bi bi-shield-shaded" style="font-size: 3rem;"></i>
                                    <div>Aggressive</div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <h5>What This Means</h5>
                                <p>Based on your responses, your risk tolerance score is <strong>{{ score }} out of {{ max_score }}</strong>. This places you in the <strong>{{ risk_level }}</strong> category for investing. Here's what that means for your investment strategy:</p>
                                {{ recommendation|safe }}
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Suggested Asset Allocation</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="allocationChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Investment Tips</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                Review your portfolio at least quarterly
                                            </li>
                                            <li class="list-group-item">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                Consider dollar-cost averaging for new investments
                                            </li>
                                            <li class="list-group-item">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                Rebalance your portfolio when allocations shift by more than 5%
                                            </li>
                                            <li class="list-group-item">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                Stay diversified across different asset classes
                                            </li>
                                            <li class="list-group-item">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                Consider consulting with a financial advisor for personalized advice
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-outline-primary" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print Your Results
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary ms-2">
                                <i class="bi bi-house"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // Asset allocation chart
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('allocationChart').getContext('2d');
                    
                    // Dynamic allocation based on risk level
                    let data = [];
                    let labels = [];
                    let backgroundColors = [];
                    
                    if ({{ risk_percent }} <= 20) {
                        // Conservative
                        data = [60, 30, 10];
                        labels = ['Bonds & Fixed Income', 'Large Cap Stocks', 'Cash & Equivalents'];
                        backgroundColors = ['#4e73df', '#1cc88a', '#36b9cc'];
                    } else if ({{ risk_percent }} <= 40) {
                        // Moderately Conservative
                        data = [45, 40, 10, 5];
                        labels = ['Bonds & Fixed Income', 'Large Cap Stocks', 'International Stocks', 'Cash'];
                        backgroundColors = ['#4e73df', '#1cc88a', '#f6c23e', '#36b9cc'];
                    } else if ({{ risk_percent }} <= 60) {
                        // Balanced
                        data = [40, 35, 15, 10];
                        labels = ['Large Cap Stocks', 'Bonds', 'International Stocks', 'Small/Mid Cap'];
                        backgroundColors = ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b'];
                    } else if ({{ risk_percent }} <= 80) {
                        // Growth-Oriented
                        data = [50, 20, 15, 10, 5];
                        labels = ['Large Cap Growth', 'International Stocks', 'Small/Mid Cap', 'Emerging Markets', 'Bonds'];
                        backgroundColors = ['#1cc88a', '#f6c23e', '#e74a3b', '#5a5c69', '#4e73df'];
                    } else {
                        // Aggressive
                        data = [40, 25, 20, 10, 5];
                        labels = ['Large Cap Growth', 'Small/Mid Cap', 'International Growth', 'Emerging Markets', 'Sector-Specific'];
                        backgroundColors = ['#1cc88a', '#e74a3b', '#f6c23e', '#5a5c69', '#36b9cc'];
                    }
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            return `${label}: ${value}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            </script>
            
        {% elif section == 'achievements' %}
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('live_market') }}">Live Market</a>
                    <a class="nav-link" href="{{ url_for('portfolio') }}">Portfolio</a>
                    <a class="nav-link" href="{{ url_for('watchlist') }}">Watchlist</a>
                    <a class="nav-link" href="{{ url_for('alerts') }}">Price Alerts</a>
                    <a class="nav-link" href="{{ url_for('risk_quiz') }}">Risk Quiz</a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </nav>
            <h2>Achievements</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <h3>Add Achievement</h3>
            <form method="POST" action="{{ url_for('update_achievements') }}">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" name="achievement" placeholder="Achievement name" required>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
            <ul class="list-group">
                {% if achievements %}
                    {% for achievement in achievements %}
                        <li class="list-group-item">{{ achievement }}</li>
                    {% endfor %}
                {% endif %}
            </ul>
        {% endif %}
    </div>
</body>
</html>